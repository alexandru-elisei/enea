{{!
    @template mod_enea/search_results
}}

<br>
<h3 class="text">{{# str}} searchresults, mod_enea {{/ str}}</h3>
<br>

<p class="text-left"> {{# str}} selectlessons, mod_enea {{/ str}}</p>

<form id="search-results-form">
    {{# has_prereq}}
    <br>
    <div class="form-row text-left lead">
        <dt><u>{{# str}} prerequisites, mod_enea {{/ str}}</u></dt>
    </div>

    {{< mod_enea/course_list_heading}}
    {{$ title}} {{# str}} title, mod_enea {{/ str}} {{/ title}}
    {{$ time}}  {{# str}} time, mod_enea {{/ str}}  {{/ time}}
    {{/ mod_enea/course_list_heading}}

    {{# prereq}}
    {{< mod_enea/course_list_row}}
    {{$ elt_name}}{{ id }}{{/ elt_name}}
    {{$ course_title}}{{ title }}{{/ course_title}}
    {{$ course_link}}{{ uri }}{{/ course_link}}
    {{$ course_time}}{{ time }}{{/ course_time}}
    {{/ mod_enea/course_list_row}}
    {{/ prereq}}
    <br>
    {{/ has_prereq}}

    <br>
    <div class="form-row text-left lead">
        <dt><u>{{# str}} recommendedlessons, mod_enea {{/ str}}</u></dt>
    </div>

    {{< mod_enea/course_list_heading}}
    {{$ title}} {{# str}} title, mod_enea {{/ str}} {{/ title}}
    {{$ time}}  {{# str}} time, mod_enea {{/ str}}  {{/ time}}
    {{/ mod_enea/course_list_heading}}

    {{# recommended}}
    {{< mod_enea/course_list_row}}
    {{$ elt_name}}{{ id }}{{/ elt_name}}
    {{$ course_title}}{{ title }}{{/ course_title}}
    {{$ course_link}}{{ uri }}{{/ course_link}}
    {{$ course_time}}{{ time }}{{/ course_time}}
    {{/ mod_enea/course_list_row}}
    {{/ recommended}}

    {{# has_postreq}}
    <br>
    <br>
    <div class="form-row text-left lead">
        <dt><u>{{# str}} followuplessons, mod_enea {{/ str}}</u></dt>
    </div>

    {{< mod_enea/course_list_heading}}
    {{$ title}} {{# str}} title, mod_enea {{/ str}} {{/ title}}
    {{$ time}}  {{# str}} time, mod_enea {{/ str}}  {{/ time}}
    {{/ mod_enea/course_list_heading}}

    {{# postreq}}
    {{< mod_enea/course_list_row}}
    {{$ elt_name}}{{ id }}{{/ elt_name}}
    {{$ course_title}}{{ uri }}{{/ course_title}}
    {{$ course_link}}{{ link }}{{/ course_link}}
    {{$ course_time}}{{ time }}{{/ course_time}}
    {{/ mod_enea/course_list_row}}
    {{/ postreq}}
    {{/ has_postreq}}

    <br>
    <div class="form-row text-left ">
        <p>{{# str}} totaltime, mod_enea {{/ str}}: {{ time }}</p>
    </div>


    {{# cmepoints}}
    <div class="form-row text-left ">
        <p>{{# str}} cmepoints, mod_enea {{/ str}}: {{ . }}</p>
    </div>
    {{/ cmepoints}}

    <div style="display: none">
        <input name="directdeps" type="hidden" value="{{ directdeps }}">
        <input name="reversedeps" type="hidden" value="{{ reversedeps }}">
        {{# id}}
        <input name="id" type="hidden" value="{{ id }}">
        {{/ id}}
        {{# cmid}}
        <input name="cmid" type="hidden" value="{{ cmid }}">
        {{/ cmid}}
    </div>

    <br>
    <div class="form-inline felement data-fieldtype="group"">
        <div class="form-group fitem">
            <input type="submit" class="btn btn-primary" name="finishbutton" value="{{# str}} finish, mod_enea {{/ str}}">
        </div>
        <input class="btn btn-secondary" type="reset" name="clearbutton" value="{{# str}} clear, mod_enea {{/ str}}">
    </div>
</form>

{{# js}}
    require(['jquery'], function($) {
        $('document').ready(function() {
            var directdeps = JSON.parse($('[name="directdeps"]').val());
            var reversedeps = JSON.parse($('[name="reversedeps"]').val());

            // When loading the document, disable all the courses that have a
            // dependency because there are no checked checkboxes on the page.
            $.each(directdeps, function(id, deps) {
                $("[name='" + id + "']").prop('disabled', true);
            });

            // For each course 'id' that has courses that depend on it check if
            // the courses that depend on it can be enabled when 'id' is
            // checked.
            $.each(reversedeps, function(id, revdeps) {
                $("[name='" + id + "']").change(function() {
                    if (!this.checked) {
                        // If 'id' is unchecked then disable all the courses
                        // that depend on it.
                        $.each(revdeps, function(_, revdep) {
                            $("[name='" + revdep + "']").prop('disabled', true);
                            $("[name='" + revdep + "']").prop('checked', false);
                        });
                    } else {
                        // For each course that depends on 'id' check that all
                        // of their dependencies are enabled and checked and
                        // enable them.
                        $.each(revdeps, function(_, revdep) {
                            to_enable = true;
                            $.each(directdeps[revdep], function(_, dirdep) {
                                if (!$("[name='" + dirdep + "']").prop('checked') ||
                                         $("[name='" + dirdep + "']").prop('disabled')) {
                                    to_enable = false;
                                }
                            });
                            if (to_enable == true) {
                                $("[name='" + revdep + "']").prop('disabled', false);
                            } else {
                                $("[name='" + revdep + "']").prop('disabled', true);
                            }
                        });
                    }
                });
            });

            $('#search-results-form').on('reset', function() {
                setTimeout(function() {
                    $.each(directdeps, function(id, deps) {
                        $("[name='" + id + "']").prop('disabled', true);
                        $("[name='" + id + "']").prop('checked', false);
                    });
                });
            });
        });
    });
{{/ js}}
