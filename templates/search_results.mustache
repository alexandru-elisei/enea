{{!
    @template mod_enea/search_results
}}

<br>
<h3 class="text">{{# str}} searchresults, mod_enea {{/ str}}</h3>
<br>
<p class="text-left"> {{# str}} selectlessons, mod_enea {{/ str}}</p>

<form id="search-results-form">
    {{# has_prereq}}
    <br>
    <div class="form-row text-left lead">
        <dt><u>{{# str}} prerequisites, mod_enea {{/ str}}</u></dt>
    </div>

    {{< mod_enea/course_list_heading}}
    {{$ title}} {{# str}} title, mod_enea {{/ str}} {{/ title}}
    {{$ time}}  {{# str}} time, mod_enea {{/ str}}  {{/ time}}
    {{/ mod_enea/course_list_heading}}

    {{# prereq}}
    {{< mod_enea/course_list_row}}
    {{$ elt_name}}{{ name }}{{/ elt_name}}
    {{$ course_title}}{{ title }}{{/ course_title}}
    {{$ course_link}}{{ link }}{{/ course_link}}
    {{$ course_time}}{{ time }}{{/ course_time}}
    {{/ mod_enea/course_list_row}}
    {{/ prereq}}
    <br>
    {{/ has_prereq}}

    <br>
    <div class="form-row text-left lead">
        <dt><u>{{# str}} recommendedlessons, mod_enea {{/ str}}</u></dt>
    </div>

    {{< mod_enea/course_list_heading}}
    {{$ title}} {{# str}} title, mod_enea {{/ str}} {{/ title}}
    {{$ time}}  {{# str}} time, mod_enea {{/ str}}  {{/ time}}
    {{/ mod_enea/course_list_heading}}

    {{# recommended}}
    {{< mod_enea/course_list_row}}
    {{$ elt_name}}{{ name }}{{/ elt_name}}
    {{$ course_title}}{{ title }}{{/ course_title}}
    {{$ course_link}}{{ link }}{{/ course_link}}
    {{$ course_time}}{{ time }}{{/ course_time}}
    {{/ mod_enea/course_list_row}}
    {{/ recommended}}

    {{# has_postreq}}
    <br>
    <br>
    <div class="form-row text-left lead">
        <dt><u>{{# str}} followuplessons, mod_enea {{/ str}}</u></dt>
    </div>

    {{< mod_enea/course_list_heading}}
    {{$ title}} {{# str}} title, mod_enea {{/ str}} {{/ title}}
    {{$ time}}  {{# str}} time, mod_enea {{/ str}}  {{/ time}}
    {{/ mod_enea/course_list_heading}}

    {{# postreq}}
    {{< mod_enea/course_list_row}}
    {{$ elt_name}}{{ name }}{{/ elt_name}}
    {{$ course_title}}{{ title }}{{/ course_title}}
    {{$ course_link}}{{ link }}{{/ course_link}}
    {{$ course_time}}{{ time }}{{/ course_time}}
    {{/ mod_enea/course_list_row}}
    {{/ postreq}}
    {{/ has_postreq}}

    <div style="display: none">
    <input name="stage" type="hidden" value="2">
    <input name="directdeps" type="hidden" value="{{ directdeps }}">
    <input name="reversedeps" type="hidden" value="{{ reversedeps }}">
    </div>

    <br>
    </div>
    <div class="form-inline felement data-fieldtype="group"">
        <div class="form-group fitem">
            <input type="submit" class="btn btn-primary" name="finishbutton" value="{{# str}} finish, mod_enea {{/ str}}">
        </div>
        <input class="btn btn-secondary" type="reset" name="clearbutton" value="{{# str}} clear, mod_enea {{/ str}}">
    </div>
</form>

{{# js}}
    require(['jquery'], function($) {
        $('document').ready(function() {
            var directdeps = JSON.parse($('[name="directdeps"]').val());
            var reversedeps = JSON.parse($('[name="reversedeps"]').val());

            // When loading the document, disable all the courses that have a
            // dependency because there are no checked checkboxes on the page.
            $.each(directdeps, function(name, deps) {
                $("[name='" + name + "']").prop('disabled', true);
            });

            // For each course 'name' that has courses that depend on it check if
            // the courses that depend on it can be enabled when 'name' is
            // checked.
            $.each(reversedeps, function(name, revdeps) {
                $("[name='" + name + "']").change(function() {
                    if (!this.checked) {
                        // If 'name' is unchecked then disable all the courses
                        // that depend on it.
                        $.each(revdeps, function(_, revdep) {
                            $("[name='" + revdep + "']").prop('disabled', true);
                        });
                    } else {
                        // For each course that depends on 'name' check that all
                        // of their dependencies are enabled and checked and
                        // enable them.
                        $.each(revdeps, function(_, revdep) {
                            to_enable = true;
                            $.each(directdeps[revdep], function(_, dirdep) {
                                if (!$("[name='" + dirdep + "']").prop('checked') ||
                                         $("[name='" + dirdep + "']").prop('disabled')) {
                                    to_enable = false;
                                }
                            });
                            if (to_enable == true) {
                                $("[name='" + revdep + "']").prop('disabled', false);
                            } else {
                                $("[name='" + revdep + "']").prop('disabled', true);
                            }
                        });
                    }
                });
            });

            $('#search-results-form').on('reset', function() {
                setTimeout(function() {
                    $.each(directdeps, function(name, deps) {
                        $("[name='" + name + "']").prop('disabled', true);
                    });
                });
            });
        });
    });
{{/ js}}
